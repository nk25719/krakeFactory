<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – Board Record</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .board-container {
      max-width: 960px;
      margin: 0 auto 2rem;
      padding: 1.5rem 2rem;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 1rem;
    }

    .search-row label {
      margin-bottom: 0;
    }

    .search-row input[type="text"] {
      max-width: 220px;
    }

    .search-row button {
      margin-left: auto;
    }

    .board-summary {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }

    .card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 0.75rem 0.9rem;
      background: #fafbff;
    }

    .card h2 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
      color: #111827;
    }

    .card p {
      margin: 0.1rem 0;
    }

    .runs-list {
      margin-top: 1rem;
    }

    .run-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 0.75rem 0.9rem;
      margin-bottom: 0.75rem;
      background: #ffffff;
    }

    .run-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .run-header h3 {
      margin: 0;
      font-size: 0.9rem;
      color: #111827;
    }

    .run-meta {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .run-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .measure-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .measure-table th,
    .measure-table td {
      padding: 0.2rem 0.25rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    .measure-table th {
      font-weight: 600;
      color: #4b5563;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-pass {
      background: #ecfdf5;
      color: #166534;
    }

    .badge-fail {
      background: #fef2f2;
      color: #b91c1c;
    }

    .badge-rework {
      background: #fffbeb;
      color: #92400e;
    }

    .status-text {
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn">Inventory</a>
    <a href="board.html" class="nav-btn active" aria-current="page">Board Record</a>
  </nav>

  <main class="board-container">
    <section class="search-row">
      <label>
        Serial Number:
        <input type="text" id="serial-input" placeholder="Enter serial e.g. LB0001">
      </label>
      <button id="load-btn" type="button">Load Board</button>
    </section>

    <section id="board-section" style="display:none;">
      <div class="board-summary">
        <div class="card" id="board-card-main"></div>
        <div class="card" id="board-card-meta"></div>
      </div>

      <section class="runs-list">
        <h2 style="font-size:0.95rem; margin:0 0 0.5rem; color:#111827;">Test Runs</h2>
        <div id="runs-container"></div>
      </section>
    </section>

    <p id="status" class="status-text"></p>
  </main>

  <script>
    const API_BASE = 'http://localhost:4000';

    const serialInput = document.getElementById('serial-input');
    const loadBtn = document.getElementById('load-btn');
    const boardSection = document.getElementById('board-section');
    const boardCardMain = document.getElementById('board-card-main');
    const boardCardMeta = document.getElementById('board-card-meta');
    const runsContainer = document.getElementById('runs-container');
    const statusEl = document.getElementById('status');

    function setStatus(message, isError = false) {
      statusEl.textContent = message || '';
      statusEl.style.color = isError ? '#b91c1c' : '#14532d';
    }

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleDateString();
    }

    function formatDateTime(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleString();
    }

    function resultBadge(result) {
      if (!result) return '';
      const val = result.toUpperCase();
      let cls = 'badge';
      if (val === 'PASS') cls += ' badge-pass';
      else if (val === 'FAIL') cls += ' badge-fail';
      else cls += ' badge-rework';
      return `<span class="${cls}">${val}</span>`;
    }

    function renderBoardCard(board) {
      const loc = [board.country || '', board.lab || '']
        .filter(Boolean)
        .join(' / ');

      boardCardMain.innerHTML = `
        <h2>Board ${board.serial_number || ''}</h2>
        <p><strong>Location:</strong> ${loc || '—'}</p>
        <p><strong>Hardware Rev:</strong> ${board.hardware_rev || '—'}</p>
        <p><strong>PCB Rev:</strong> ${board.pcb_rev || '—'}</p>
        <p><strong>Batch:</strong> ${board.batch || '—'}</p>
      `;

      const dateAsm = board.date_assembled
        ? formatDate(board.date_assembled)
        : '—';

      const gdtLink = board.gdt_url
        ? `<a href="${board.gdt_url}" target="_blank" rel="noopener noreferrer">${board.gdt_key || board.gdt_url}</a>`
        : (board.gdt_key || '—');

      boardCardMeta.innerHTML = `
        <h2>Assembly & GDT</h2>
        <p><strong>Date Assembled:</strong> ${dateAsm}</p>
        <p><strong>Assembled By:</strong> ${board.assembled_by || '—'}</p>
        <p><strong>GDT Key / URL:</strong> ${gdtLink}</p>
      `;
    }

    function renderRuns(test_runs) {
      runsContainer.innerHTML = '';

      if (!test_runs.length) {
        runsContainer.innerHTML = `
          <p style="font-size:0.8rem; color:#6b7280; margin:0.25rem 0 0;">
            No test runs recorded for this board yet.
          </p>
        `;
        return;
      }

      for (const run of test_runs) {
        const card = document.createElement('article');
        card.className = 'run-card';

        const dtLabel = formatDateTime(run.test_datetime);
        const header = document.createElement('div');
        header.className = 'run-header';

        header.innerHTML = `
          <div>
            <h3>Test at ${run.test_location || 'unknown'}</h3>
            <div class="run-meta">
              ${dtLabel ? dtLabel + ' · ' : ''}Tester: ${run.tester || '—'}
            </div>
          </div>
          <div class="run-meta">
            Firmware: ${run.firmware_version || '—'}<br>
            Result: ${resultBadge(run.overall_result || '')}
          </div>
        `;

        const grid = document.createElement('div');
        grid.className = 'run-grid';

        // Unpowered block
        const unpBlock = document.createElement('div');
        const unp = (run.unpowered_results && run.unpowered_results[0]) || {};
        unpBlock.innerHTML = `
          <h4 style="margin:0 0 0.3rem; font-size:0.8rem;">Unpowered Measurements</h4>
          <table class="measure-table">
            <tbody>
              <tr><th>Meter</th><td>${[unp.meter_make, unp.meter_model].filter(Boolean).join(' ')} ${unp.meter_sn ? '(' + unp.meter_sn + ')' : ''}</td></tr>
              <tr><th>TP102–TP101 Vin</th><td>${unp.res_tp102_tp101_vin || '—'}</td></tr>
              <tr><th>TP103–TP101 +5V</th><td>${unp.res_tp103_tp101_5v || '—'}</td></tr>
              <tr><th>TP201–TP101 VBus</th><td>${unp.res_tp201_tp101_vbus || '—'}</td></tr>
              <tr><th>TP202–TP101 V3</th><td>${unp.res_tp202_tp101_v3 || '—'}</td></tr>
              <tr><th>J103 Pin2–TP101</th><td>${unp.res_j103pin2_tp101_ctrl_vcc || '—'}</td></tr>
              <tr><th>Result</th><td>${resultBadge(unp.pass_fail || '')}</td></tr>
              <tr><th>Notes</th><td>${unp.notes || '—'}</td></tr>
            </tbody>
          </table>
        `;

        // Powered block
        const powBlock = document.createElement('div');
        const pow = (run.powered_results && run.powered_results[0]) || {};
        powBlock.innerHTML = `
          <h4 style="margin:0 0 0.3rem; font-size:0.8rem;">Powered Measurements</h4>
          <table class="measure-table">
            <tbody>
              <tr><th>Supply Current (mA)</th><td>${pow.supply_current_ma ?? '—'}</td></tr>
              <tr><th>TP102 Vin (V)</th><td>${pow.vin_tp102_v ?? '—'}</td></tr>
              <tr><th>TP103 +5V (V)</th><td>${pow.v5_tp103_v ?? '—'}</td></tr>
              <tr><th>+5esp32 U103 (V)</th><td>${pow.v5_esp32_u103_v ?? '—'}</td></tr>
              <tr><th>+3.3V Tab U103 (V)</th><td>${pow.v3p3_tab_u103_v ?? '—'}</td></tr>
              <tr><th>TP202 V3 U501 (V)</th><td>${pow.v3_tp202_u501_v ?? '—'}</td></tr>
              <tr><th>D103 Cathode 3v3Ctrl (V)</th><td>${pow.v3v3_ctrl_d103k_v ?? '—'}</td></tr>
              <tr><th>TP401 VccLCD (V)</th><td>${pow.vcclcd_tp401_v ?? '—'}</td></tr>
              <tr><th>C505+ 5VDFP (V)</th><td>${pow.v5_dfp_c505_v ?? '—'}</td></tr>
              <tr><th>Charge Pump + (V)</th><td>${pow.v_charge_pump_plus_v ?? '—'}</td></tr>
              <tr><th>Charge Pump - (V)</th><td>${pow.v_charge_pump_minus_v ?? '—'}</td></tr>
              <tr><th>Result</th><td>${resultBadge(pow.pass_fail || '')}</td></tr>
              <tr><th>Notes</th><td>${pow.notes || '—'}</td></tr>
            </tbody>
          </table>
        `;

        grid.appendChild(unpBlock);
        grid.appendChild(powBlock);

        card.appendChild(header);
        card.appendChild(grid);
        runsContainer.appendChild(card);
      }
    }

    async function loadBoard() {
      const serial = serialInput.value.trim();
      if (!serial) {
        setStatus('Please enter a serial number.', true);
        boardSection.style.display = 'none';
        return;
      }

      setStatus('Loading board…', false);
      boardSection.style.display = 'none';
      runsContainer.innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/api/board/${encodeURIComponent(serial)}`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }

        const data = await res.json();
        if (!data.board) {
          setStatus(`No board found with serial "${serial}".`, false);
          return;
        }

        renderBoardCard(data.board);
        renderRuns(data.test_runs || []);
        boardSection.style.display = '';
        setStatus(`Loaded board ${data.board.serial_number} with ${data.test_runs?.length || 0} run(s).`, false);
      } catch (err) {
        console.error(err);
        setStatus('Error loading board: ' + err.message, true);
      }
    }

    loadBtn.addEventListener('click', loadBoard);
    serialInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadBoard();
      }
    });
  </script>
</body>
</html>
