<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<!-- <h1>Krake Factory Test Log</h1> -->
<p style="text-align:center; margin-top:-0.3rem; margin-bottom:1rem;">
 
  <nav class="top-nav">
  <a href="factory-form.html" class="nav-btn active" aria-current="page">Krake Testing Register</a>
  <a href="records.html" class="nav-btn">Inventory</a>
  <a href="board.html" class="nav-btn">Board Record</a>
  <a href="all-tables.html" class="nav-btn">Data Base</a>

</nav>

  
  <form id="test-form">
    <!-- BOARD INFO -->
    <fieldset>
      <legend>Board Information</legend>

      <label>Serial Number (serial_number):
        <input type="text" id="serial_number" required>
      </label><br>

      <label>Hardware Rev:
        <input type="text" id="hardware_rev" value="Rev2.0">
      </label><br>

      <label>PCB Rev:
        <input type="text" id="pcb_rev" value="PCB v2.0">
      </label><br>

      <label>Batch:
        <input type="text" id="batch" placeholder="e.g. 2025-03-JLC-A">
      </label><br>

      <label>Country:
        <select id="country">
          <option>Lebanon</option>
          <option>UK</option>
          <option>US</option>
        </select>
      </label><br>

      <label>Lab:
        <input type="text" id="lab" placeholder="Beirut Lab / London Lab / US Lab">
      </label><br>

      <label>Date Assembled:
        <input type="date" id="date_assembled">
      </label><br>

      <label>Assembled By:
        <input type="text" id="assembled_by">
      </label><br>
    </fieldset>

    <br>

    <!-- TEST RUN INFO -->
    <fieldset>
      <legend>Test Run (General)</legend>

      <label>Test Location:
        <select id="test_location">
          <option>Lebanon</option>
          <option>London</option>
          <option>US</option>
        </select>
      </label><br>

      <label>Tester:
        <input type="text" id="tester" required>
      </label><br>

      <label>Firmware Version:
        <input type="text" id="firmware_version" value="0.40">
      </label><br>

      <label>Test Fixture Version:
        <input type="text" id="test_fixture_version" placeholder="e.g. Jig v1.0">
      </label><br>

      <label>Overall Result:
        <select id="overall_result">
          <option>PASS</option>
          <option>FAIL</option>
          <option>REWORK</option>
        </select>
      </label><br>

      <label>Comments:<br>
        <textarea id="comments" rows="3" cols="40"></textarea>
      </label><br>
    </fieldset>

    <br>

    <!-- UNPOWERED RESULTS -->
    <fieldset>
      <legend>Unpowered Test (Resistance)</legend>

      <p>Test with multimeter before applying power.</p>

      <label>Meter Make:
        <input type="text" id="meter_make" placeholder="ASTRO /\I">
      </label><br>

      <label>Meter Model:
        <input type="text" id="meter_model" placeholder="DM6000AR">
      </label><br>

      <label>Meter Serial Number:
        <input type="text" id="meter_sn" placeholder="2327610969">
      </label><br><br>

      <label>Resistance TP102–TP101 (Vin):
        <input type="text" id="res_tp102_tp101_vin" placeholder=">10Meg">
      </label><br>

      <label>Resistance TP103–TP101 (+5V):
        <input type="text" id="res_tp103_tp101_5v" placeholder="1.1K Typical">
      </label><br>

      <label>Resistance TP201–TP101 (VBus):
        <input type="text" id="res_tp201_tp101_vbus" placeholder="Open">
      </label><br>

      <label>Resistance TP202–TP101 (V3):
        <input type="text" id="res_tp202_tp101_v3" placeholder="304 Ohm">
      </label><br>

      <label>Resistance J103 Pin2–TP101 (ControllerVcc):
        <input type="text" id="res_j103pin2_tp101_ctrl_vcc" placeholder=">10Meg">
      </label><br>

      <label>Unpowered Test Result:
        <select id="unpowered_pass_fail">
          <option>PASS</option>
          <option>FAIL</option>
        </select>
      </label><br>

      <label>Unpowered Notes:<br>
        <textarea id="unpowered_notes" rows="2" cols="40"></textarea>
      </label><br>
    </fieldset>

    <br>

    <!-- POWERED RESULTS -->
    <fieldset>
      <legend>Powered Tests (Current & Voltages)</legend>

      <label>Supply Current at J101 (mA):
        <input type="number" step="0.1" id="supply_current_ma" placeholder="e.g. 147">
      </label><br>

      <label>TP102 Vin (V):
        <input type="number" step="0.01" id="vin_tp102_v" placeholder="8.33">
      </label><br>

      <label>TP103 +5V (V):
        <input type="number" step="0.01" id="v5_tp103_v" placeholder="5.046">
      </label><br>

      <label>+5esp32 into U103 (V):
        <input type="number" step="0.01" id="v5_esp32_u103_v" placeholder="4.929">
      </label><br>

      <label>+3.3V Tab U103 (V):
        <input type="number" step="0.01" id="v3p3_tab_u103_v" placeholder="3.318">
      </label><br>

      <label>TP202 V3 on U501 (V):
        <input type="number" step="0.01" id="v3_tp202_u501_v" placeholder="3.314">
      </label><br>

      <label>D103 Cathode 3v3Controller (V):
        <input type="number" step="0.01" id="v3v3_ctrl_d103k_v" placeholder="3.208">
      </label><br>

      <label>TP401 VccLCD (V):
        <input type="number" step="0.01" id="vcclcd_tp401_v" placeholder="4.999">
      </label><br>

      <label>C505+ 5VDFP (V):
        <input type="number" step="0.01" id="v5_dfp_c505_v" placeholder="5.031">
      </label><br>

      <label>ChargePump + (U701 Pin2) (V):
        <input type="number" step="0.01" id="v_charge_pump_plus_v" placeholder="5.36">
      </label><br>

      <label>ChargePump - (U701 Pin6) (V):
        <input type="number" step="0.01" id="v_charge_pump_minus_v" placeholder="-5.70">
      </label><br>

      <label>Powered Test Result:
        <select id="powered_pass_fail">
          <option>PASS</option>
          <option>FAIL</option>
        </select>
      </label><br>

      <label>Powered Notes:<br>
        <textarea id="powered_notes" rows="2" cols="40"></textarea>
      </label><br>
    </fieldset>

    <br>
    <button type="submit">Save Test Run</button>
  </form>

  <p id="status"></p>

  <!-- Supabase JS client via CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ⚠️ REPLACE THESE TWO LINES with your actual values
    // From Supabase dashboard: Settings → API → Project URL + anon public key
    const SUPABASE_URL = 'https://bkonmvhzzlbrbtnvlfcr.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrb25tdmh6emxicmJ0bnZsZmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMjUxNjIsImV4cCI6MjA3ODgwMTE2Mn0.yrg1t-aHWuwVEVcUVJ4-sbz1BNSspc7c5tBSQ3APTAg'

    const { createClient } = supabase
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const form = document.getElementById('test-form')
    const statusEl = document.getElementById('status')

    function numOrNull(id) {
      const v = document.getElementById(id).value
      return v === '' ? null : Number(v)
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      statusEl.textContent = 'Saving...'

      // --- BOARD FIELDS ---
      const serial_number      = document.getElementById('serial_number').value.trim()
      const hardware_rev       = document.getElementById('hardware_rev').value.trim()
      const pcb_rev            = document.getElementById('pcb_rev').value.trim()
      const batch              = document.getElementById('batch').value.trim()
      const country            = document.getElementById('country').value
      const lab                = document.getElementById('lab').value.trim()
      const date_assembled     = document.getElementById('date_assembled').value || null
      const assembled_by       = document.getElementById('assembled_by').value.trim()

      // --- TEST RUN FIELDS ---
      const test_location      = document.getElementById('test_location').value
      const tester             = document.getElementById('tester').value.trim()
      const firmware_version   = document.getElementById('firmware_version').value.trim()
      const test_fixture_version = document.getElementById('test_fixture_version').value.trim()
      const overall_result     = document.getElementById('overall_result').value
      const comments           = document.getElementById('comments').value.trim()

      // --- UNPOWERED FIELDS ---
      const meter_make         = document.getElementById('meter_make').value.trim()
      const meter_model        = document.getElementById('meter_model').value.trim()
      const meter_sn           = document.getElementById('meter_sn').value.trim()

      const res_tp102_tp101_vin         = document.getElementById('res_tp102_tp101_vin').value.trim()
      const res_tp103_tp101_5v          = document.getElementById('res_tp103_tp101_5v').value.trim()
      const res_tp201_tp101_vbus        = document.getElementById('res_tp201_tp101_vbus').value.trim()
      const res_tp202_tp101_v3          = document.getElementById('res_tp202_tp101_v3').value.trim()
      const res_j103pin2_tp101_ctrl_vcc = document.getElementById('res_j103pin2_tp101_ctrl_vcc').value.trim()
      const unpowered_pass_fail         = document.getElementById('unpowered_pass_fail').value
      const unpowered_notes             = document.getElementById('unpowered_notes').value.trim()

      // --- POWERED FIELDS ---
      const supply_current_ma      = numOrNull('supply_current_ma')
      const vin_tp102_v           = numOrNull('vin_tp102_v')
      const v5_tp103_v            = numOrNull('v5_tp103_v')
      const v5_esp32_u103_v       = numOrNull('v5_esp32_u103_v')
      const v3p3_tab_u103_v       = numOrNull('v3p3_tab_u103_v')
      const v3_tp202_u501_v       = numOrNull('v3_tp202_u501_v')
      const v3v3_ctrl_d103k_v     = numOrNull('v3v3_ctrl_d103k_v')
      const vcclcd_tp401_v        = numOrNull('vcclcd_tp401_v')
      const v5_dfp_c505_v         = numOrNull('v5_dfp_c505_v')
      const v_charge_pump_plus_v  = numOrNull('v_charge_pump_plus_v')
      const v_charge_pump_minus_v = numOrNull('v_charge_pump_minus_v')
      const powered_pass_fail     = document.getElementById('powered_pass_fail').value
      const powered_notes         = document.getElementById('powered_notes').value.trim()

      try {
        // 1) UPSERT BOARD BY SERIAL NUMBER
        const { data: board, error: boardError } = await db
          .from('boards')
          .upsert(
            {
              serial_number,
              hardware_rev,
              pcb_rev,
              batch,
              country,
              lab,
              date_assembled,
              assembled_by
            },
            { onConflict: 'serial_number' }
          )
          .select()
          .single()

        if (boardError) {
          console.error(boardError)
          statusEl.textContent = 'Error saving board: ' + boardError.message
          return
        }

        // 2) INSERT TEST RUN
        const { data: testRun, error: runError } = await db
          .from('test_runs')
          .insert({
            board_id: board.board_id,
            tester,
            firmware_version,
            test_fixture_version,
            test_location,
            overall_result,
            comments
          })
          .select()
          .single()

        if (runError) {
          console.error(runError)
          statusEl.textContent = 'Error saving test run: ' + runError.message
          return
        }

        const testrun_id = testRun.testrun_id

        // 3) INSERT UNPOWERED RESULTS
        const { error: unpoweredError } = await db
          .from('unpowered_results')
          .insert({
            testrun_id,
            meter_make,
            meter_model,
            meter_sn,
            res_tp102_tp101_vin,
            res_tp103_tp101_5v,
            res_tp201_tp101_vbus,
            res_tp202_tp101_v3,
            res_j103pin2_tp101_ctrl_vcc,
            pass_fail: unpowered_pass_fail,
            notes: unpowered_notes
          })

        if (unpoweredError) {
          console.error(unpoweredError)
          statusEl.textContent = 'Error saving unpowered results: ' + unpoweredError.message
          return
        }

        // 4) INSERT POWERED RESULTS
        const { error: poweredError } = await db
          .from('powered_results')
          .insert({
            testrun_id,
            supply_current_ma,
            vin_tp102_v,
            v5_tp103_v,
            v5_esp32_u103_v,
            v3p3_tab_u103_v,
            v3_tp202_u501_v,
            v3v3_ctrl_d103k_v,
            vcclcd_tp401_v,
            v5_dfp_c505_v,
            v_charge_pump_plus_v,
            v_charge_pump_minus_v,
            pass_fail: powered_pass_fail,
            notes: powered_notes
          })

        if (poweredError) {
          console.error(poweredError)
          statusEl.textContent = 'Error saving powered results: ' + poweredError.message
          return
        }

        statusEl.textContent = '✅ All data saved!'
        form.reset()
      } catch (err) {
        console.error(err)
        statusEl.textContent = 'Unexpected error: ' + err.message
      }
    })
  </script>
</body>
</html>
