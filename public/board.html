<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – Board Details</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn">Inventory &amp; History</a>
    <a href="board.html" class="nav-btn active">Test History</a>
    <a href="labels.html" class="nav-btn">QR Label from Image</a>
  </nav>

  <div class="board-container">
    <header class="board-header">
      <h1 id="boardTitle">Board Details</h1>
      <p id="boardMeta" class="board-meta"></p>
    </header>

    <section id="boardInfo" class="board-info">
      <!-- Filled by JS -->
    </section>

    <section id="runsSection">
      <h2>Test Runs</h2>
      <div id="runsList" class="runs-list">
        <!-- Filled by JS -->
      </div>
    </section>
  </div>

<script>
  const API_BASE = ''; // same origin

  function getSerialFromQuery() {
    const params = new URLSearchParams(window.location.search);
    return params.get('serial') || '';
  }

  async function loadBoardDetails() {
    const serial = getSerialFromQuery();
    const title = document.getElementById('boardTitle');
    const meta = document.getElementById('boardMeta');
    const info = document.getElementById('boardInfo');
    const runsList = document.getElementById('runsList');

    if (!serial) {
      title.textContent = 'No serial provided';
      info.textContent = 'Please open this page with ?serial=...';
      return;
    }

    title.textContent = `Board ${serial}`;
    meta.textContent = 'Loading...';

    try {
      const resp = await fetch(`${API_BASE}/api/board/${encodeURIComponent(serial)}`);
      if (!resp.ok) {
        throw new Error(`Server error: ${resp.status}`);
      }
      const data = await resp.json();

      if (!data.board) {
        meta.textContent = 'Board not found';
        info.textContent = '';
        runsList.innerHTML = '';
        return;
      }

      const b = data.board;
      meta.textContent = [
        b.country || '-',
        b.lab || '-',
        b.status || '-'
      ].join(' · ');

      info.innerHTML = `
        <div class="info-grid">
          <div><strong>Serial:</strong> ${b.serial_number || ''}</div>
          <div><strong>Hardware Rev:</strong> ${b.hardware_rev || ''}</div>
          <div><strong>PCB Rev:</strong> ${b.pcb_rev || ''}</div>
          <div><strong>Batch:</strong> ${b.batch || ''}</div>
          <div><strong>Date Assembled:</strong> ${b.date_assembled || ''}</div>
          <div><strong>Assembled By:</strong> ${b.assembled_by || ''}</div>
          <div><strong>GDT Key:</strong> ${b.gdt_key || ''}</div>
          <div><strong>GDT URL:</strong> ${
            b.gdt_url ? `<a href="${b.gdt_url}" target="_blank">${b.gdt_url}</a>` : ''
          }</div>
          <div class="info-notes"><strong>Notes:</strong> ${b.notes || ''}</div>
        </div>
      `;

      if (!data.test_runs || !data.test_runs.length) {
        runsList.innerHTML = '<p>No test runs recorded yet.</p>';
        return;
      }

      runsList.innerHTML = '';
      for (const run of data.test_runs) {
        const card = document.createElement('article');
        card.className = 'run-card';

        const dt = run.test_datetime
          ? new Date(run.test_datetime).toLocaleString()
          : '(no date)';

        const resultClass =
          run.overall_result === 'PASS' ? 'result-pass' :
          run.overall_result === 'FAIL' ? 'result-fail' : 'result-other';

        card.innerHTML = `
          <header class="run-header">
            <div>
              <div class="run-datetime">${dt}</div>
              <div class="run-location">
                ${run.test_location || ''} · Tester: ${run.tester || ''}
              </div>
            </div>
            <div class="run-result ${resultClass}">
              ${run.overall_result || ''}
            </div>
          </header>

          <section class="run-firmware">
            <div><strong>Firmware:</strong> ${run.firmware_version || ''}</div>
            <div><strong>Fixture Ver:</strong> ${run.test_fixture_version || ''}</div>
          </section>

          <section class="run-measurements">
            <div class="measure-group">
              <h3>Unpowered</h3>
              ${
                run.unpowered_results && run.unpowered_results.length
                  ? renderUnpowered(run.unpowered_results[0])
                  : '<p class="dim">No unpowered measurements.</p>'
              }
            </div>
            <div class="measure-group">
              <h3>Powered</h3>
              ${
                run.powered_results && run.powered_results.length
                  ? renderPowered(run.powered_results[0])
                  : '<p class="dim">No powered measurements.</p>'
              }
            </div>
          </section>

          <section class="run-comments">
            <strong>Comments:</strong> ${run.comments || ''}
          </section>
        `;

        runsList.appendChild(card);
      }
    } catch (err) {
      console.error(err);
      meta.textContent = `Error: ${err.message}`;
      document.getElementById('boardInfo').textContent = '';
      document.getElementById('runsList').innerHTML = '';
    }
  }

  function renderUnpowered(u) {
    return `
      <p><strong>Meter:</strong> ${u.meter_make || ''} ${u.meter_model || ''} (SN: ${u.meter_sn || ''})</p>
      <ul class="measure-list">
        <li>RES TP102-TP101 Vin: ${u.res_tp102_tp101_vin || ''}</li>
        <li>RES TP103-TP101 5V: ${u.res_tp103_tp101_5v || ''}</li>
        <li>RES TP201-TP101 VBUS: ${u.res_tp201_tp101_vbus || ''}</li>
        <li>RES TP202-TP101 V3: ${u.res_tp202_tp101_v3 || ''}</li>
        <li>RES J103pin2-TP101 CTRL_VCC: ${u.res_j103pin2_tp101_ctrl_vcc || ''}</li>
      </ul>
      <p><strong>Result:</strong> ${u.pass_fail || ''}</p>
      <p><strong>Notes:</strong> ${u.notes || ''}</p>
    `;
  }

  function renderPowered(p) {
    const num = (v) => (v === null || v === undefined ? '' : v);
    return `
      <ul class="measure-list">
        <li>Supply Current (mA): ${num(p.supply_current_ma)}</li>
        <li>Vin TP102 (V): ${num(p.vin_tp102_v)}</li>
        <li>V5 TP103 (V): ${num(p.v5_tp103_v)}</li>
        <li>+5esp32 U103 (V): ${num(p.v5_esp32_u103_v)}</li>
        <li>3.3V Tab U103 (V): ${num(p.v3p3_tab_u103_v)}</li>
        <li>V3 TP202 U501 (V): ${num(p.v3_tp202_u501_v)}</li>
        <li>3v3 Controller D103K (V): ${num(p.v3v3_ctrl_d103k_v)}</li>
        <li>VccLCD TP401 (V): ${num(p.vcclcd_tp401_v)}</li>
        <li>5VDFP C505+ (V): ${num(p.v5_dfp_c505_v)}</li>
        <li>Charge Pump + (V): ${num(p.v_charge_pump_plus_v)}</li>
        <li>Charge Pump – (V): ${num(p.v_charge_pump_minus_v)}</li>
      </ul>
      <p><strong>Result:</strong> ${p.pass_fail || ''}</p>
      <p><strong>Notes:</strong> ${p.notes || ''}</p>
    `;
  }

  loadBoardDetails();
</script>
</body>
</html>
