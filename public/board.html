<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – Board Record</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn">Inventory</a>
    <a href="board.html" class="nav-btn active" aria-current="page">Board Record</a>
    <a href="labels.html" class="nav-btn" >QR Labels</a>
  </nav>

  <div class="board-container">
    <div class="search-row">
      <label>
        Serial number:
        <input type="text" id="serial-input" placeholder="e.g. LB0001">
      </label>
      <button type="button" id="search-btn">Load Board</button>
    </div>

    <p id="status"></p>

    <div id="board-info"></div>
    <div id="tests-container" class="tests-list"></div>
  </div>

  <script>
    const API_BASE = '';
    const serialInput = document.getElementById('serial-input');
    const searchBtn = document.getElementById('search-btn');
    const statusEl = document.getElementById('status');
    const boardInfoEl = document.getElementById('board-info');
    const testsContainerEl = document.getElementById('tests-container');

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || '';
      statusEl.style.color = isError ? '#b91c1c' : '#14532d';
    }

    function formatDateTime(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleString();
    }

    function renderBoard(board) {
      const loc = [board.country || '', board.lab || ''].filter(Boolean).join(' / ');
      const dateAsm = board.date_assembled
        ? new Date(board.date_assembled).toLocaleDateString()
        : '—';
      const gdtLink = board.gdt_url
        ? `<a href="${board.gdt_url}" target="_blank" rel="noopener">${board.gdt_url}</a>`
        : '—';

      boardInfoEl.innerHTML = `
        <div class="board-card">
          <h2>Board ${board.serial_number || ''}</h2>
          <div class="board-meta-grid">
            <div><strong>Hardware Rev:</strong> ${board.hardware_rev || '—'}</div>
            <div><strong>PCB Rev:</strong> ${board.pcb_rev || '—'}</div>
            <div><strong>Batch:</strong> ${board.batch || '—'}</div>
            <div><strong>Location:</strong> ${loc || '—'}</div>
            <div><strong>Date Assembled:</strong> ${dateAsm}</div>
            <div><strong>Assembled By:</strong> ${board.assembled_by || '—'}</div>
            <div><strong>Status:</strong> ${board.status || '—'}</div>
            <div><strong>GDT Key:</strong> ${board.gdt_key || '—'}</div>
            <div><strong>GDT URL:</strong> ${gdtLink}</div>
          </div>
        </div>
      `;
    }

    function renderTests(testRuns) {
      testsContainerEl.innerHTML = '';

      if (!testRuns || !testRuns.length) {
        testsContainerEl.innerHTML =
          '<p style="font-size:0.85rem;color:#6b7280;">No test runs for this board.</p>';
        return;
      }

      testRuns.forEach((run, i) => {
        const res = (run.overall_result || '').toUpperCase();
        let badgeClass = 'badge';
        if (res === 'PASS') badgeClass += ' badge-pass';
        else if (res === 'FAIL') badgeClass += ' badge-fail';
        else if (res === 'REWORK') badgeClass += ' badge-rework';

        const unp = (run.unpowered_results || [])[0] || {};
        const pow = (run.powered_results || [])[0] || {};

        const wrapper = document.createElement('div');
        wrapper.className = 'test-item';

        const header = document.createElement('div');
        header.className = 'test-header';
        header.innerHTML = `
          <div>
            Run #${testRuns.length - i} &middot;
            <span class="${badgeClass}">${res || '—'}</span>
            &middot; ${formatDateTime(run.test_datetime) || 'Unknown time'}
          </div>
          <div>
            ${run.test_location || '—'} &middot;
            ${run.tester || '—'} &middot;
            FW ${run.firmware_version || '—'}
          </div>
        `;

        const body = document.createElement('div');
        body.className = 'test-body';
        body.innerHTML = `
          <h3 style="margin:0 0 0.3rem;font-size:0.8rem;">Unpowered</h3>
          <table class="mini-table">
            <tbody>
              <tr><th>Meter</th><td>${(unp.meter_make || '') + ' ' + (unp.meter_model || '')}</td></tr>
              <tr><th>Meter S/N</th><td>${unp.meter_sn || ''}</td></tr>
              <tr><th>TP102–TP101 (Vin)</th><td>${unp.res_tp102_tp101_vin || ''}</td></tr>
              <tr><th>TP103–TP101 (+5V)</th><td>${unp.res_tp103_tp101_5v || ''}</td></tr>
              <tr><th>TP201–TP101 (VBus)</th><td>${unp.res_tp201_tp101_vbus || ''}</td></tr>
              <tr><th>TP202–TP101 (V3)</th><td>${unp.res_tp202_tp101_v3 || ''}</td></tr>
              <tr><th>J103 Pin2–TP101 (Ctrl Vcc)</th><td>${unp.res_j103pin2_tp101_ctrl_vcc || ''}</td></tr>
              <tr><th>Result</th><td>${unp.pass_fail || ''}</td></tr>
            </tbody>
          </table>

          <h3 style="margin:0.6rem 0 0.3rem;font-size:0.8rem;">Powered</h3>
          <table class="mini-table">
            <tbody>
              <tr><th>I<sub>in</sub> J101 (mA)</th><td>${pow.supply_current_ma ?? ''}</td></tr>
              <tr><th>TP102 Vin (V)</th><td>${pow.vin_tp102_v ?? ''}</td></tr>
              <tr><th>TP103 +5V (V)</th><td>${pow.v5_tp103_v ?? ''}</td></tr>
              <tr><th>+5esp32 → U103 (V)</th><td>${pow.v5_esp32_u103_v ?? ''}</td></tr>
              <tr><th>+3.3V Tab U103 (V)</th><td>${pow.v3p3_tab_u103_v ?? ''}</td></tr>
              <tr><th>TP202 V3 U501 (V)</th><td>${pow.v3_tp202_u501_v ?? ''}</td></tr>
              <tr><th>D103 Cathode 3v3Ctrl (V)</th><td>${pow.v3v3_ctrl_d103k_v ?? ''}</td></tr>
              <tr><th>TP401 VccLCD (V)</th><td>${pow.vcclcd_tp401_v ?? ''}</td></tr>
              <tr><th>C505+ 5VDFP (V)</th><td>${pow.v5_dfp_c505_v ?? ''}</td></tr>
              <tr><th>Charge Pump + (V)</th><td>${pow.v_charge_pump_plus_v ?? ''}</td></tr>
              <tr><th>Charge Pump - (V)</th><td>${pow.v_charge_pump_minus_v ?? ''}</td></tr>
              <tr><th>Result</th><td>${pow.pass_fail || ''}</td></tr>
            </tbody>
          </table>
        `;

        header.addEventListener('click', () => {
          const open = body.classList.contains('open');
          body.classList.toggle('open', !open);
        });

        wrapper.appendChild(header);
        wrapper.appendChild(body);
        testsContainerEl.appendChild(wrapper);
      });
    }

    async function loadBoard() {
      const serial = serialInput.value.trim();
      if (!serial) {
        setStatus('Please enter a serial number.', true);
        return;
      }

      setStatus('Loading board...');
      boardInfoEl.innerHTML = '';
      testsContainerEl.innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/api/board/${encodeURIComponent(serial)}`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const data = await res.json();
        if (!data.board) {
          setStatus('Board not found.', true);
          return;
        }
        renderBoard(data.board);
        renderTests(data.test_runs || []);
        setStatus(`Loaded board ${data.board.serial_number}, ${ (data.test_runs || []).length } run(s).`);
      } catch (err) {
        console.error(err);
        setStatus('Error loading board: ' + err.message, true);
      }
    }

    searchBtn.addEventListener('click', loadBoard);
    serialInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadBoard();
      }
    });
  </script>
</body>
</html>
