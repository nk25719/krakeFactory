<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="top-nav">
    <a href="factory-form.html" class="nav-btn active">Krake Testing Register</a>
    <a href="records.html" class="nav-btn">Inventory &amp; History</a>
    <a href="board.html" class="nav-btn">Test History</a>
    <a href="labels.html" class="nav-btn">QR Label from Image</a>
  </nav>

<div class="board-container">
  <h2>Test plugins</h2>
  <form id="testForm">
    <fieldset>
      <legend>Basic Board Details</legend>
      <label>
        Serial Number *
        <input type="text" name="serial_number" required />
      </label>
      <label>
        Hardware Rev
        <input type="text" name="hardware_rev" />
      </label>
      <label>
        PCB Rev
        <input type="text" name="pcb_rev" />
      </label>
      <label>
        Batch
        <input type="text" name="batch" />
      </label>
      <label>
        Date Assembled
        <input type="date" name="date_assembled" />
      </label>
      <label>
        Assembled By
        <input type="text" name="assembled_by" />
      </label>
      <label>
        Country
        <input type="text" name="country" />
      </label>
      <label>
        Lab
        <input type="text" name="lab" />
      </label>
      <label>
        Status
        <input type="text" name="status" placeholder="IN_STOCK / IN_TEST / SHIPPED / REWORK" />
      </label>
      <label>
        GDT Key
        <input type="text" name="gdt_key" />
      </label>
      <label>
        GDT URL
        <input type="url" name="gdt_url" />
      </label>
      <label>
        Notes
        <textarea name="notes"></textarea>
      </label>
    </fieldset>

    <fieldset>
      <legend>Test Run Info</legend>
      <label>
        Test Location
        <input type="text" name="test_location" placeholder="Lebanon / London / US" />
      </label>
      <label>
        Tester
        <input type="text" name="tester" />
      </label>
      <label>
        Firmware Version
        <input type="text" name="firmware_version" />
      </label>
      <label>
        Test Fixture Version
        <input type="text" name="test_fixture_version" />
      </label>
      <label>
        Overall Result
        <select name="overall_result">
          <option value="">(select)</option>
          <option value="PASS">PASS</option>
          <option value="FAIL">FAIL</option>
          <option value="REWORK">REWORK</option>
        </select>
      </label>
      <label>
        Comments
        <textarea name="comments"></textarea>
      </label>
    </fieldset>

    <fieldset>
      <legend>Unpowered Measurements</legend>
      <label>
        Meter Make
        <input type="text" name="meter_make" />
      </label>
      <label>
        Meter Model
        <input type="text" name="meter_model" />
      </label>
      <label>
        Meter Serial #
        <input type="text" name="meter_sn" />
      </label>

      <label>
        RES TP102-TP101 Vin
        <input type="text" name="res_tp102_tp101_vin" placeholder=">10Meg" />
      </label>
      <label>
        RES TP103-TP101 5V
        <input type="text" name="res_tp103_tp101_5v" />
      </label>
      <label>
        RES TP201-TP101 VBUS
        <input type="text" name="res_tp201_tp101_vbus" />
      </label>
      <label>
        RES TP202-TP101 V3
        <input type="text" name="res_tp202_tp101_v3" />
      </label>
      <label>
        RES J103pin2-TP101 CTRL_VCC
        <input type="text" name="res_j103pin2_tp101_ctrl_vcc" />
      </label>
      <label>
        Pass / Fail
        <select name="unpowered_pass_fail">
          <option value="">(select)</option>
          <option value="PASS">PASS</option>
          <option value="FAIL">FAIL</option>
        </select>
      </label>
      <label>
        Unpowered Notes
        <textarea name="unpowered_notes"></textarea>
      </label>
    </fieldset>

    <fieldset>
      <legend>Powered Measurements</legend>
      <label>
        Supply Current (mA)
        <input type="number" step="0.01" name="supply_current_ma" />
      </label>
      <label>
        Vin TP102 (V)
        <input type="number" step="0.001" name="vin_tp102_v" />
      </label>
      <label>
        V5 TP103 (V)
        <input type="number" step="0.001" name="v5_tp103_v" />
      </label>
      <label>
        +5esp32 U103 (V)
        <input type="number" step="0.001" name="v5_esp32_u103_v" />
      </label>
      <label>
        3.3V Tab U103 (V)
        <input type="number" step="0.001" name="v3p3_tab_u103_v" />
      </label>
      <label>
        V3 TP202 U501 (V)
        <input type="number" step="0.001" name="v3_tp202_u501_v" />
      </label>
      <label>
        3v3 Controller D103K (V)
        <input type="number" step="0.001" name="v3v3_ctrl_d103k_v" />
      </label>
      <label>
        VccLCD TP401 (V)
        <input type="number" step="0.001" name="vcclcd_tp401_v" />
      </label>
      <label>
        5VDFP C505+ (V)
        <input type="number" step="0.001" name="v5_dfp_c505_v" />
      </label>
      <label>
        Charge Pump + (V)
        <input type="number" step="0.001" name="v_charge_pump_plus_v" />
      </label>
      <label>
        Charge Pump – (V)
        <input type="number" step="0.001" name="v_charge_pump_minus_v" />
      </label>
      <label>
        Powered Pass / Fail
        <select name="powered_pass_fail">
          <option value="">(select)</option>
          <option value="PASS">PASS</option>
          <option value="FAIL">FAIL</option>
        </select>
      </label>
      <label>
        Powered Notes
        <textarea name="powered_notes"></textarea>
      </label>
    </fieldset>

    <div class="button-row">
      <button type="submit">Save Test Run</button>
      <span id="statusMsg" class="status-msg"></span>
    </div>
  </form>
</div>

<script>
  // Same origin as Node/nginx
  const API_BASE = '';

  const form = document.getElementById('testForm');
  const statusMsg = document.getElementById('statusMsg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusMsg.textContent = 'Saving...';

    const fd = new FormData(form);

    const board = {
      serial_number: fd.get('serial_number'),
      hardware_rev: fd.get('hardware_rev') || null,
      pcb_rev: fd.get('pcb_rev') || null,
      batch: fd.get('batch') || null,
      date_assembled: fd.get('date_assembled') || null,
      assembled_by: fd.get('assembled_by') || null,
      country: fd.get('country') || null,
      lab: fd.get('lab') || null,
      status: fd.get('status') || null,
      gdt_key: fd.get('gdt_key') || null,
      gdt_url: fd.get('gdt_url') || null,
      notes: fd.get('notes') || null
    };

    const test_run = {
      test_location: fd.get('test_location') || null,
      tester: fd.get('tester') || null,
      firmware_version: fd.get('firmware_version') || null,
      test_fixture_version: fd.get('test_fixture_version') || null,
      overall_result: fd.get('overall_result') || null,
      comments: fd.get('comments') || null
    };

    const unpowered = {
      meter_make: fd.get('meter_make') || null,
      meter_model: fd.get('meter_model') || null,
      meter_sn: fd.get('meter_sn') || null,
      res_tp102_tp101_vin: fd.get('res_tp102_tp101_vin') || null,
      res_tp103_tp101_5v: fd.get('res_tp103_tp101_5v') || null,
      res_tp201_tp101_vbus: fd.get('res_tp201_tp101_vbus') || null,
      res_tp202_tp101_v3: fd.get('res_tp202_tp101_v3') || null,
      res_j103pin2_tp101_ctrl_vcc: fd.get('res_j103pin2_tp101_ctrl_vcc') || null,
      pass_fail: fd.get('unpowered_pass_fail') || null,
      notes: fd.get('unpowered_notes') || null
    };

    const powered = {
      supply_current_ma: fd.get('supply_current_ma') || null,
      vin_tp102_v: fd.get('vin_tp102_v') || null,
      v5_tp103_v: fd.get('v5_tp103_v') || null,
      v5_esp32_u103_v: fd.get('v5_esp32_u103_v') || null,
      v3p3_tab_u103_v: fd.get('v3p3_tab_u103_v') || null,
      v3_tp202_u501_v: fd.get('v3_tp202_u501_v') || null,
      v3v3_ctrl_d103k_v: fd.get('v3v3_ctrl_d103k_v') || null,
      vcclcd_tp401_v: fd.get('vcclcd_tp401_v') || null,
      v5_dfp_c505_v: fd.get('v5_dfp_c505_v') || null,
      v_charge_pump_plus_v: fd.get('v_charge_pump_plus_v') || null,
      v_charge_pump_minus_v: fd.get('v_charge_pump_minus_v') || null,
      pass_fail: fd.get('powered_pass_fail') || null,
      notes: fd.get('powered_notes') || null
    };

    const payload = { board, test_run, unpowered, powered };

    try {
      const resp = await fetch(`${API_BASE}/api/test-run`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Server error: ${resp.status} – ${text}`);
      }

      const data = await resp.json();
      statusMsg.textContent = `Saved. Board ID: ${data.board_id}, Run ID: ${data.testrun_id}`;
      statusMsg.style.color = '#2e7d32';
      form.reset();
    } catch (err) {
      console.error(err);
      statusMsg.textContent = `Error: ${err.message}`;
      statusMsg.style.color = '#c62828';
    }
  });
</script>
</body>
</html>
