<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – QR Label from Image</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn">Inventory &amp; History</a>
    <a href="board.html" class="nav-btn">Test History</a>
    <a href="labels.html" class="nav-btn active">QR Label from Image</a>
  </nav>

  <div class="labels-container">
    <header class="labels-header">
      <h1>QR Label from Existing Image</h1>
      <p class="dim">
        Upload a QR code image, specify label dimensions in mm, and download a printable PDF
        with the QR and a caption (e.g., the serial number).
      </p>
    </header>

    <form id="labelForm" class="labels-form">
      <label>
        Serial Number *
        <input type="text" name="serial" required placeholder="e.g. KRK-LB-001">
      </label>

      <label>
        Caption (optional)
        <input type="text" name="caption" placeholder="If blank, 'Serial: &lt;serial&gt;' is used">
      </label>

      <div class="labels-dimensions">
        <label>
          Width (mm)
          <input type="number" name="width_mm" value="50" min="10" step="1">
        </label>
        <label>
          Height (mm)
          <input type="number" name="height_mm" value="30" min="10" step="1">
        </label>
      </div>

      <label>
        QR Image File *
        <input type="file" name="qr_image" accept="image/*" required>
      </label>

      <div class="button-row">
        <button type="submit" class="btn-primary">Generate PDF Label</button>
        <span id="statusMsg" class="status-msg"></span>
      </div>
    </form>
  </div>

<script>
  const API_BASE = ''; // same origin

  const form = document.getElementById('labelForm');
  const statusMsg = document.getElementById('statusMsg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusMsg.textContent = 'Generating PDF ...';
    statusMsg.style.color = '#394263';

    const fd = new FormData(form);

    try {
      const resp = await fetch(`${API_BASE}/api/labels/qr-image-pdf`, {
        method: 'POST',
        body: fd
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Server error: ${resp.status} – ${text}`);
      }

      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      const serial = (fd.get('serial') || 'label').replace(/[^a-zA-Z0-9_-]/g, '_');
      a.href = url;
      a.download = `label-${serial}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
      statusMsg.textContent = 'PDF downloaded.';
      statusMsg.style.color = '#2e7d32';
    } catch (err) {
      console.error(err);
      statusMsg.textContent = `Error: ${err.message}`;
      statusMsg.style.color = '#c62828';
    }
  });
</script>
</body>
</html>
