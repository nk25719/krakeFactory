<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – Inventory</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .records-container {
      max-width: 960px;
      margin: 0 auto 2rem;
      padding: 1.5rem 2rem;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: flex-end;
    }

    .filters label {
      margin-bottom: 0;
    }

    .filters input[type="text"],
    .filters select {
      max-width: 180px;
    }

    .filters button {
      margin-left: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #eef1fb;
    }

    th, td {
      border: 1px solid #d5d7e2;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #394263;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f8f9ff;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-pass {
      background: #e6f6ec;
      color: #14532d;
      border: 1px solid #83c39c;
    }

    .badge-fail {
      background: #fde8e8;
      color: #7f1d1d;
      border: 1px solid #f19999;
    }

    .badge-rework {
      background: #fff7e6;
      color: #92400e;
      border: 1px solid #f3c580;
    }

    @media (max-width: 700px) {
      .records-container {
        padding: 1.25rem 1.1rem;
        margin: 0 0.5rem 1.5rem;
      }

      table {
        font-size: 0.78rem;
      }

      th, td {
        padding: 0.25rem 0.3rem;
      }
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn active" aria-current="page">Inventory</a>
    <a href="board.html" class="nav-btn">Board Record</a>
  </nav>

  <div class="records-container">
    <div class="filters">
      <label>
        Serial contains:
        <input type="text" id="filter-serial" placeholder="e.g. LB0001">
      </label>

      <label>
        Location:
        <select id="filter-location">
          <option value="ALL">All</option>
          <option value="Lebanon">Lebanon</option>
          <option value="London">London</option>
          <option value="US">US</option>
        </select>
      </label>

      <label>
        Result:
        <select id="filter-result">
          <option value="ALL">All</option>
          <option value="PASS">PASS</option>
          <option value="FAIL">FAIL</option>
          <option value="REWORK">REWORK</option>
        </select>
      </label>

      <button type="button" id="reload-btn">Reload</button>
    </div>

    <p id="status"></p>

    <table>
      <thead>
        <tr>
          <th>Serial</th>
          <th>Board Location</th>
          <th>Test Date/Time</th>
          <th>Test Location</th>
          <th>Tester</th>
          <th>Firmware</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="records-body">
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000';
    const statusEl = document.getElementById('status');
    const tbody = document.getElementById('records-body');

    const filterSerial = document.getElementById('filter-serial');
    const filterLocation = document.getElementById('filter-location');
    const filterResult = document.getElementById('filter-result');
    const reloadBtn = document.getElementById('reload-btn');

    let lastData = [];

    function setStatus(message, isError = false) {
      statusEl.textContent = message || '';
      statusEl.style.color = isError ? '#b91c1c' : '#14532d';
    }

    function formatDateTime(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      if (isNaN(d)) return isoString;
      return d.toLocaleString();
    }

    function renderTable() {
      const serialFilter = filterSerial.value.trim().toLowerCase();
      const locationFilter = filterLocation.value;
      const resultFilter = filterResult.value;

      tbody.innerHTML = '';

      const filtered = lastData.filter(row => {
        const serial = (row.serial_number || '').toLowerCase();
        const testLoc = row.test_location || '';
        const result = row.overall_result || '';

        if (serialFilter && !serial.includes(serialFilter)) return false;
        if (locationFilter !== 'ALL' && testLoc !== locationFilter) return false;
        if (resultFilter !== 'ALL' && result !== resultFilter) return false;

        return true;
      });

      if (!filtered.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.textContent = 'No records match the current filters.';
        td.style.textAlign = 'center';
        td.style.color = '#6b7280';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const row of filtered) {
        const tr = document.createElement('tr');

        const serial = row.serial_number || '(unknown)';
        const country = row.country || '';
        const lab = row.lab || '';
        const boardLoc = [country, lab].filter(Boolean).join(' / ');

        const tdSerial = document.createElement('td');
        tdSerial.textContent = serial;

        const tdBoardLoc = document.createElement('td');
        tdBoardLoc.textContent = boardLoc || '—';

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDateTime(row.test_datetime);

        const tdTestLoc = document.createElement('td');
        tdTestLoc.textContent = row.test_location || '—';

        const tdTester = document.createElement('td');
        tdTester.textContent = row.tester || '—';

        const tdFirmware = document.createElement('td');
        tdFirmware.textContent = row.firmware_version || '—';

        const tdResult = document.createElement('td');
        const span = document.createElement('span');
        const res = (row.overall_result || '').toUpperCase();
        span.textContent = res || '—';
        span.classList.add('badge');
        if (res === 'PASS') span.classList.add('badge-pass');
        else if (res === 'FAIL') span.classList.add('badge-fail');
        else if (res === 'REWORK') span.classList.add('badge-rework');
        tdResult.appendChild(span);

        tr.appendChild(tdSerial);
        tr.appendChild(tdBoardLoc);
        tr.appendChild(tdDate);
        tr.appendChild(tdTestLoc);
        tr.appendChild(tdTester);
        tr.appendChild(tdFirmware);
        tr.appendChild(tdResult);

        tbody.appendChild(tr);
      }
    }

    async function loadRecords() {
      setStatus('Loading records...');
      tbody.innerHTML = '';

      try {
        const res = await fetch(`${API_BASE}/api/test-runs`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const data = await res.json();
        lastData = Array.isArray(data) ? data : [];
        setStatus(`Loaded ${lastData.length} test runs.`);
        renderTable();
      } catch (err) {
        console.error(err);
        setStatus('Error loading records: ' + err.message, true);
      }
    }

    reloadBtn.addEventListener('click', loadRecords);
    filterSerial.addEventListener('input', renderTable);
    filterLocation.addEventListener('change', renderTable);
    filterResult.addEventListener('change', renderTable);

    // Initial load
    loadRecords();
  </script>
</body>
</html>
